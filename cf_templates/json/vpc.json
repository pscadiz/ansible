{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "cf_templates/json/vpc.json",

    "Parameters": {
        "region": {
            "Description": "AWS region",
            "Type": "String"
        },

        "vpcCidr": {
            "Description": "VPC CIDR block",
            "Type": "String"
        },

        "vpcEnv": {
            "Description": "VPC environment string",
            "Type": "String"
        },

        "appSubnets": {
            "Description": "Application subnet CIDR blocks",
            "Type": "CommaDelimitedList"
        },

        "dataSubnets": {
            "Description": "Data subnet CIDR blocks",
            "Type": "CommaDelimitedList"
        },

        "serviceSubnets": {
            "Description": "Service subnet CIDR blocks",
            "Type": "CommaDelimitedList"
        }

    },

    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": { "Ref": "vpcCidr" },
                "EnableDnsSupport": "true",
                "EnableDnsHostnames": "true",
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "vpc" ] ] } }
                ]
            }
        },

        "AppSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": { "Fn::Join": ["", [ { "Ref": "region" }, "a" ] ] },
                "CidrBlock": { "Fn::Select": [ "0", { "Ref": "appSubnets" } ] },
                "VpcId": { "Ref": "VPC" },
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "appsubnet-a" ] ] } }
                ]
            }
        },

        "AppSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": { "Fn::Join": ["", [ { "Ref": "region" }, "b" ] ] },
                "CidrBlock": { "Fn::Select": [ "1", { "Ref": "appSubnets" } ] },
                "VpcId": { "Ref": "VPC" },
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "appsubnet-b" ] ] } }
                ]
            }
        },

        "DataSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": { "Fn::Join": ["", [ { "Ref": "region" }, "a" ] ] },
                "CidrBlock": { "Fn::Select": [ "0", { "Ref": "dataSubnets" } ] },
                "VpcId": { "Ref": "VPC" },
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "datasubnet-a" ] ] } }
                ]
            }
        },

        "DataSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": { "Fn::Join": ["", [ { "Ref": "region" }, "b" ] ] },
                "CidrBlock": { "Fn::Select": [ "1", { "Ref": "dataSubnets" } ] },
                "VpcId": { "Ref": "VPC" },
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "datasubnet-b" ] ] } }
                ]
            }
        },

        "ServiceSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": { "Fn::Join": ["", [ { "Ref": "region" }, "a" ] ] },
                "CidrBlock": { "Fn::Select": [ "0", { "Ref": "serviceSubnets" } ] },
                "VpcId": { "Ref": "VPC" },
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "servicesubnet-a" ] ] } }
                ]
            }
        },

        "ServiceSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": { "Fn::Join": ["", [ { "Ref": "region" }, "b" ] ] },
                "CidrBlock": { "Fn::Select": [ "1", { "Ref": "serviceSubnets" } ] },
                "VpcId": { "Ref": "VPC" },
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "servicesubnet-b" ] ] } }
                ]
            }
        },

        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "internet-gateway" ] ] } }
                ]
            }
        },

        "InternetGatewayAttachment": {
            "DependsOn": "InternetGateway",
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": { "Ref": "InternetGateway" },
                "VpcId": { "Ref": "VPC" }
            }
        },

        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": { "Ref": "VPC" },
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "routetable-public" ] ] } }
                ]
            }
        },

        "PublicRoute": {
            "DependsOn": [ "InternetGateway", "InternetGatewayAttachment" ],
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": { "Ref": "PublicRouteTable" },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": { "Ref": "InternetGateway" }
            }
        },

        "ServiceSubnetARouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": { "Ref": "ServiceSubnetA" },
                "RouteTableId": { "Ref": "PublicRouteTable" }
            }
        },

        "ServiceSubnetBRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": { "Ref": "ServiceSubnetB" },
                "RouteTableId": { "Ref": "PublicRouteTable" }
            }
        },

        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": { "Ref": "VPC" },
                "Tags": [
                    { "Key": "Name", "Value": { "Fn::Join": ["-", [ { "Ref": "vpcEnv" }, "routetable-private" ] ] } }
                ]
            }
        }
    },

    "Outputs": {
        "vpcId": {
            "Description": "Logical ID of VPC",
            "Value": { "Ref": "VPC" }
        },

        "internetGatewayId": {
            "Description": "Logical ID of InternetGateway",
            "Value": { "Ref": "InternetGateway" }
        },

        "publicRouteTableId": {
            "Description": "Logical ID of PublicRouteTable",
            "Value": { "Ref": "PublicRouteTable" }
        },

        "privateRouteTableId": {
            "Description": "Logical ID of PrivateRouteTable",
            "Value": { "Ref": "PrivateRouteTable" }
        },

        "appSubnetAId": {
            "Description": "Logical ID of AppSubnetA",
            "Value": { "Ref": "AppSubnetA" }
        },

        "appSubnetBId": {
            "Description": "Logical ID of AppSubnetB",
            "Value": { "Ref": "AppSubnetB" }
        },

        "dataSubnetAId": {
            "Description": "Logical ID of DataSubnetA",
            "Value": { "Ref": "DataSubnetA" }
        },

        "dataSubnetBId": {
            "Description": "Logical ID of DataSubnetB",
            "Value": { "Ref": "DataSubnetB" }
        },

        "serviceSubnetAId": {
            "Description": "Logical ID of ServiceSubnetA",
            "Value": { "Ref": "ServiceSubnetA" }
        },

        "serviceSubnetBId": {
            "Description": "Logical ID of ServiceSubnetB",
            "Value": { "Ref": "ServiceSubnetB" }
        }
    }
}